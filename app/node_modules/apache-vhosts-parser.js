/**
 * Parse Apache virtual hosts file
 * @param {string} file_path
 * @returns {Array} List of virtual host objects
 */
exports.parse = function(file_path) {
	var fs = require('fs');
	var exp = /<VirtualHost .+>[\w\s\t."':\\/@-]+<\/VirtualHost>/g;
	var vhosts_file = fs.readFileSync(file_path).toString();

	// get virtual host attributes
	vhosts = getVHostAttributes(vhosts_file.match(exp));

	// create virtual host objects
	return createVHostsObject(vhosts);
};

/**
 * Get list virtual host attributes
 *
 * @param list
 * @returns {Array} List of virtual hosts arrays
 */
function getVHostAttributes(list) {
	var whiteSpaceFilter = function(line) { return line.trim(); };

	return list.map(function(vhost_string) {
		var vhost_arr = vhost_string.split('\n');

		// remove delimiters
		vhost_arr.splice(0,1); // <VirtualHost *>
		vhost_arr.pop(); // </VirtualHost>

		return vhost_arr.map(whiteSpaceFilter);
	});
}

/**
 * Convert list of attribute strings to list of virtual host objects
 *
 * @param list
 * @returns {Array}
 */
function createVHostsObject(list) {
	var id = 0;

	var doubleQuotesFilter = function(string) {
		return string.replace(/"/g, '');
	};

	var setAttribute = function(obj, attr) {
		var arr = attr.split(' '),
			name = arr.splice(0,1),
			i = 0;

		obj[name] = doubleQuotesFilter(arr.join(' '));
	};

	// Each virtual host is an array of attribute strings
	// Each attribute is composed from 'attributeName attributeValue [otherPossibleValue]'
	return list.map(function(vhostAttrs) {
		var obj = {}, i = 0;

		obj.id = id++;

		// convert attributes to object
		for(; i < vhostAttrs.length; i++) {
			setAttribute(obj, vhostAttrs[i]);
		}

		return obj;
	});
}
